env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  DATABASE_URL: "postgresql://postgres:postgres@postgres:5432/github_crawler"

steps:
- uses: actions/checkout@v4

- name: Set up Python
  uses: actions/setup-python@v5
  with:
    python-version: '3.11'

- name: Install dependencies
  run: |
    pip install --upgrade pip
    pip install -r requirements.txt

- name: Wait for Postgres
  run: |
    until pg_isready -h postgres -p 5432; do sleep 1; done

- name: Create tables
  run: python scripts/setup_db.py

- name: Run crawler
  run: python main.py

- name: Export data to CSV
  run: python scripts/export_csv.py

- name: Upload CSV
  uses: actions/upload-artifact@v4
  with:
    name: github-repositories
    path: repositories.csv
    retention-days: 7
